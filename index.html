<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Pedestrian and Bicyclist Safety Risk Assessment Tool</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.10/esri/css/main.css">
  <script src="https://js.arcgis.com/4.10/"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/4.10/dijit/themes/claro/claro.css">


  <script>
    require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer", 
        "esri/widgets/Search", 
        "esri/renderers/ClassBreaksRenderer",
        "esri/widgets/Legend",       
        "esri/renderers/smartMapping/creators/color",
        "esri/renderers/smartMapping/statistics/histogram",
        "esri/core/lang",
        "esri/WebMap",
        "esri/core/watchUtils",       
        "esri/Graphic",
        "esri/layers/GraphicsLayer"
      ],
      function(
        Map, MapView,FeatureLayer, 
        Search, ClassBreaksRenderer, 
        Legend, colorRendererCreator, 
        histogram, lang, WebMap, 
        watchUtils, Graphic, 
        GraphicsLayer, dom
      ) {
        const map = new Map({
          basemap: "gray"
        });
        console.log("Map ready");
        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-83.7430, 42.2808],
          zoom: 13
        });

        // search widget ============================================================
        var searchWidget = new Search({
          view: view, 
          popupEnabled: false
        });
        view.ui.add(searchWidget, {
          position: "top-right"
        });
        // ==========================================================================
        var fieldDictionary = {
          "Bike_Index_of_the_Environment": "Bie", 
          "Bike_Exposure": "BikeExp", 
          "Bike_Risk": "Bike_Risk", 
          "Non_Motorized_Exposure": "NMExp", 
          "Non_Motorized_Risk": "NMRisk", 
          "Pedestrian_Exposure" :"PedExp", 
          "Pedestrian_Risk": "Ped_Risk", 
          "Pedestrian_Index_of_the_Environment": "Pie"
        };
        // Create the popup template for polygon 
        const popupTemplatePolygon = { // autocasts as new PopupTemplate()
          title: "Polygon information, FID: {FID}",
          content: [{
            type: "fields",
            fieldInfos: [{
              fieldName: "FID",
              label: "FID",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "BErank",
              label: "BErank",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "BIErank",
              label: "BIErank",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "BRrank",
              label: "BRrank",
              format: {
                places: 0,
                digitSeparator: true
              }
            },{
              fieldName: "Bie",
              label: "Bike_Index_of_the_Environment ",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "BikeCrashC",
              label: "Bike_Crash_Count",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "BikeExp",
              label: "Bike_Exposure",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "Bike_Risk",
              label: "Bike_Risk",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "NMErank",
              label: "NMErank",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "NMExp",
              label: "Non_Motorized_Exposure",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "NMRisk",
              label: "Non_Motorized_Risk",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "NMRrank",
              label: "NMRrank",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "PErank",
              label: "PErank",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "PIErank",
              label: "PIErank",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "PRrank",
              label: "PRrank",
              format: {
                places: 0,
                digitSeparator: true
              }
            },{
              fieldName: "PedCrashCt",
              label: "Pedestrian_Crash_Count",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "Pie",
              label: "Pedestrian_Index_of_Environment ",
              format: {
                places: 0,
                digitSeparator: true
              }
            },{
              fieldName: "PedExp",
              label: "Pedestrial_Exposure",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "Ped_Risk",
              label: "Pedestrian_Risk",
              format: {
                places: 0,
                digitSeparator: true
              }
            },{
              fieldName: "Rid",
              label: "Rid",
              format: {
                places: 0,
                digitSeparator: true
              }
            },{
              fieldName: "fips",
              label: "fips",
              format: {
                places: 0,
                digitSeparator: true
              }
            }]
          }]
        };
        // Create the popup template for line bike 
        const popupTemplateLineBike = { // autocasts as new PopupTemplate()
          title: "Bike road information, FID: {FID}",
          content: [{
            type: "fields",
            fieldInfos: [{
              fieldName: "FID",
              label: "FID",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "rank",
              label: "rank",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "weight",
              label: "weight",
              format: {
                places: 0,
                digitSeparator: true
              }
            }]
          }]
        };
        // Create the popup template for line pedestrian 
        const popupTemplateLinePed = { // autocasts as new PopupTemplate()
          title: "Pedestrian road information, FID: {FID}",
          content: [{
            type: "fields",
            fieldInfos: [{
              fieldName: "FID",
              label: "FID",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "rank",
              label: "rank",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "weight",
              label: "weight",
              format: {
                places: 0,
                digitSeparator: true
              }
            }]
          }]
        };
        // Create the popup template for point 
        const popupTemplatePoint = { // autocasts as new PopupTemplate()
          title: "Point information, ID: {idx}",
          content: [{
            type: "fields",
            fieldInfos: [{
              fieldName: "idx",
              label: "idx",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "year",
              label: "year",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "month",
              label: "month",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "day",
              label: "day",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "time",
              label: "time",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "worst_injury",
              label: "worst_injury",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "type",
              label: "type",
              format: {
                places: 0,
                digitSeparator: true
              }
            }]
          }]
        };
        // Color bin individual bin definition
        const less25 = {
          type: "simple-fill",  // autocasts as new SimpleFillSymbol()
          color: "#fffcd4",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less50 = {
          type: "simple-fill",  
          color: "#b1cdc2",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const more50 = {
          type: "simple-fill", 
          color: "#38627a",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const more75 = {
          type: "simple-fill",  
          color: "#0d2644",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };

        const less20_Ped_Risk = {
          type: "simple-fill",  
          color: "#f2f0f7",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less40_Ped_Risk = {
          type: "simple-fill",  
          color: "#cbc9e2",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less60_Ped_Risk = {
          type: "simple-fill",  
          color: "#9e9ac8",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less80_Ped_Risk = {
          type: "simple-fill",  
          color: "#756bb1",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less100_Ped_Risk = {
          type: "simple-fill",  
          color: "#54278f",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };

        const less20_Bike_Exp = {
          type: "simple-fill",  
          color: "#ffffcc",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less40_Bike_Exp = {
          type: "simple-fill",  
          color: "#a1dab4",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less60_Bike_Exp = {
          type: "simple-fill",  
          color: "#41b6c4",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less80_Bike_Exp = {
          type: "simple-fill",  
          color: "#2c7fb8",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less100_Bike_Exp = {
          type: "simple-fill",  
          color: "#253494",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };

        const less20_Ped_Exp = {
          type: "simple-fill",  
          color: "#edf8fb",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less40_Ped_Exp = {
          type: "simple-fill",  
          color: "#b2e2e2",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less60_Ped_Exp = {
          type: "simple-fill",  
          color: "#66c2a4",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less80_Ped_Exp = {
          type: "simple-fill",  
          color: "#2ca25f",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less100_Ped_Exp = {
          type: "simple-fill",  
          color: "#006d2c",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };

        const less20_Bike_Risk = {
          type: "simple-fill",  
          color: "#ffffd4",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less40_Bike_Risk = {
          type: "simple-fill",  
          color: "#fed98e",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less60_Bike_Risk = {
          type: "simple-fill",  
          color: "#fe9929",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less80_Bike_Risk = {
          type: "simple-fill",  
          color: "#d95f0e",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };
        const less100_Bike_Risk = {
          type: "simple-fill",  
          color: "#993404",
          style: "solid",
          outline: {
            width: 0.2,
            color: [ 255, 255, 255, 0.5 ]
          }
        };

        const BikeRoadColors = {
        	colorsForClassBreaks: {
        		colors: [0, 1, 2, 3, 4],
        		numClasses: 5
        	}
        };

        // Color bin definition Pie 
        const rendererPolygonPie = {
          type: "class-breaks", 
          field: "Pie",  
          legendOptions: {title: "PIE values"},
          defaultSymbol: {
            type: "simple-fill",  
            color: "black",
            style: "backward-diagonal",
            outline: {
              width: 0.5,
              color: [50,50,50,0.6]
            }
          },
          defaultLabel: "no data", 
          classBreakInfos: [{
            minValue: 0,
            maxValue: 7.999,
            symbol: less20_Ped_Risk,
            label: "0 to 8" 
          }, {
            minValue: 8,
            maxValue: 21.999,
            symbol: less40_Ped_Risk,
            label: "8 to 22" 
          }, {
            minValue: 22,
            maxValue: 30.999,
            symbol: less60_Ped_Risk,
            label: "22 to 31"
          }, {
            minValue: 31,
            maxValue: 42.999,
            symbol: less80_Ped_Risk,
            label: "31 to 43" 
          }, {
          	minValue: 43,
            maxValue: 75,
            symbol: less100_Ped_Risk,
            label: "43 to 75"
          }]
        };
        // Color bin definition Bie 
        const rendererPolygonBie = {
          type: "class-breaks", 
          field: "Bie",  
          legendOptions: {title: "BIE values"},
          defaultSymbol: {
            type: "simple-fill",  
            color: "black",
            style: "backward-diagonal",
            outline: {
              width: 0.5,
              color: [50,50,50,0.6]
            }
          },
          defaultLabel: "no data", 
          classBreakInfos: [{
            minValue: 0,
            maxValue: 10.999,
            symbol: less25,
            label: "0 to 11" 
          }, {
            minValue: 11,
            maxValue: 15.999,
            symbol: less50,
            label: "11 to 16" 
          }, {
            minValue: 16,
            maxValue: 34.999,
            symbol: more50,
            label: "16 to 35"
          }, {
            minValue: 35,
            maxValue: 54.999,
            symbol: more75,
            label: "35 to 55" 
          }, {
          	minValue: 55,
            maxValue: 99,
            symbol: more75,
            label: "55 to 99" 
          }]
        };

        const rendererPolygon_PedRisk = {
          type: "class-breaks", 
          field: "Ped_Risk",  
          legendOptions: {title: "Pedestrian Risk Values"},
          defaultSymbol: {
            type: "simple-fill",  
            color: "black",
            style: "backward-diagonal",
            outline: {
              width: 0.5,
              color: [50,50,50,0.6]
            }
          },
          defaultLabel: "no data", 
          classBreakInfos: [{
            minValue: 0.1,
            maxValue: 0.199,
            symbol: less20_Ped_Risk,
            label: "0.1 to 0.2" 
          }, {
            minValue: 0.2,
            maxValue: 0.999,
            symbol: less40_Ped_Risk,
            label: "0.2 to 1" 
          }, {
            minValue: 1,
            maxValue: 4.999,
            symbol: less60_Ped_Risk,
            label: "1 to 5"
          }, {
            minValue: 5,
            maxValue: 11.999,
            symbol: less80_Ped_Risk,
            label: "5 to 12" 
          }, {
          	minValue: 12,
          	maxValue: 50,
          	symbol: less100_Ped_Risk,
          	label: "12 to 50"
          }]
        };

        const rendererPolygon_BikeRisk = {
          type: "class-breaks", 
          field: "Ped_Risk",  
          legendOptions: {title: "Bicycle Risk Values"},
          defaultSymbol: {
            type: "simple-fill",  
            color: "black",
            style: "backward-diagonal",
            outline: {
              width: 0.5,
              color: [50,50,50,0.6]
            }
          },
          defaultLabel: "no data", 
          classBreakInfos: [{
            minValue: 0.1,
            maxValue: 0.199,
            symbol: less20_Bike_Risk,
            label: "0.1 to 0.2" 
          }, {
            minValue: 0.2,
            maxValue: 0.999,
            symbol: less40_Bike_Risk,
            label: "0.2 to 1" 
          }, {
            minValue: 1,
            maxValue: 3.999,
            symbol: less60_Bike_Risk,
            label: "1 to 4"
          }, {
            minValue: 4,
            maxValue: 8.999,
            symbol: less80_Bike_Risk,
            label: "4 to 9" 
          }, {
          	minValue: 9,
          	maxValue: 50,
          	symbol: less100_Bike_Risk,
          	label: "9 to 50"
          }]
        };

        const rendererPolygon_NM_Risk = {
          type: "class-breaks", 
          field: "Ped_Risk",  
          legendOptions: {title: "Non-Motorized Risk Values"},
          defaultSymbol: {
            type: "simple-fill",  
            color: "black",
            style: "backward-diagonal",
            outline: {
              width: 0.5,
              color: [50,50,50,0.6]
            }
          },
          defaultLabel: "no data", 
          classBreakInfos: [{
            minValue: 0.1,
            maxValue: 0.299,
            symbol: less20_Ped_Risk,
            label: "0.1 to 0.3" 
          }, {
            minValue: 0.3,
            maxValue: 1.999,
            symbol: less40_Ped_Risk,
            label: "0.3 to 2" 
          }, {
            minValue: 2,
            maxValue: 6.999,
            symbol: less60_Ped_Risk,
            label: "2 to 7"
          }, {
            minValue: 7,
            maxValue: 15.999,
            symbol: less80_Ped_Risk,
            label: "7 to 16" 
          }, {
          	minValue: 16,
          	maxValue: 70,
          	symbol: less100_Ped_Risk,
          	label: "16 to 70"
          }]
        };

        const rendererPolygon_PedExposure = {
          type: "class-breaks", 
          field: "Ped_Risk",  
          legendOptions: {title: "Pedestrian Exposure Values"},
          defaultSymbol: {
            type: "simple-fill",  
            color: "black",
            style: "backward-diagonal",
            outline: {
              width: 0.5,
              color: [50,50,50,0.6]
            }
          },
          defaultLabel: "no data", 
          classBreakInfos: [{
            minValue: 1,
            maxValue: 3.999,
            symbol: less20_Ped_Exp,
            label: "0.1 to 0.2" 
          }, {
            minValue: 4,
            maxValue: 19.999,
            symbol: less40_Ped_Exp,
            label: "0.2 to 1" 
          }, {
            minValue: 20,
            maxValue: 79.999,
            symbol: less60_Ped_Exp,
            label: "1 to 5"
          }, {
            minValue: 80,
            maxValue: 199.999,
            symbol: less80_Ped_Exp,
            label: "5 to 12" 
          }, {
          	minValue: 200,
          	maxValue: 2400,
          	symbol: less100_Ped_Exp,
          	label: "12 to 50"
          }]
        };

        const rendererPolygon_BikeExposure = {
          type: "class-breaks", 
          field: "Ped_Risk",  
          legendOptions: {title: "Bike Exposure Values"},
          defaultSymbol: {
            type: "simple-fill",  
            color: "black",
            style: "backward-diagonal",
            outline: {
              width: 0.5,
              color: [50,50,50,0.6]
            }
          },
          defaultLabel: "no data", 
          classBreakInfos: [{
            minValue: 1,
            maxValue: 3.999,
            symbol: less20_Bike_Exp,
            label: "1 to 4" 
          }, {
            minValue: 4,
            maxValue: 14.999,
            symbol: less40_Bike_Exp,
            label: "4 to 15" 
          }, {
            minValue: 15,
            maxValue: 44.999,
            symbol: less60_Bike_Exp,
            label: "15 to 45"
          }, {
            minValue: 45,
            maxValue: 84.999,
            symbol: less80_Bike_Exp,
            label: "45 to 85" 
          }, {
          	minValue: 85,
          	maxValue: 1100,
          	symbol: less100_Bike_Exp,
          	label: "85 to 1100"
          }]
        };

        const rendererPolygon_NM_Exposure = {
          type: "class-breaks", 
          field: "Ped_Risk",  
          legendOptions: {title: "Non-Motorized Exposure Values"},
          defaultSymbol: {
            type: "simple-fill",  
            color: "black",
            style: "backward-diagonal",
            outline: {
              width: 0.5,
              color: [50,50,50,0.6]
            }
          },
          defaultLabel: "no data", 
          classBreakInfos: [{
            minValue: 1,
            maxValue: 4.999,
            symbol: less20_Bike_Exp,
            label: "1 to 5" 
          }, {
            minValue: 5,
            maxValue: 29.999,
            symbol: less40_Bike_Exp,
            label: "5 to 30" 
          }, {
            minValue: 30,
            maxValue: 114.999,
            symbol: less60_Bike_Exp,
            label: "30 to 115"
          }, {
            minValue: 115,
            maxValue: 264.999,
            symbol: less80_Bike_Exp,
            label: "115 to 265" 
          }, {
          	minValue: 265,
          	maxValue: 3500,
          	symbol: less100_Bike_Exp,
          	label: "265 to 3500"
          }]
        };

        // Point layer definition by individual type
        const schoolSym = {
          type: "simple-marker", 
          color: "orange",
          width: 5,
          style: "circle"
        };
        const barSym = {
          type: "simple-marker", 
          color: "#blue",
          width: 5,
          style: "square"
        };
        
        const bikeSym = {
          type: "simple-marker", 
          color: "red",
          width: 5,
          style: "diamond"
        };
        
        const pedSym = {
          type: "simple-marker", 
          color: "green",
          width: 5,
          style: "triangle"
        };
        // Point layer definition
        const rendererPoint = {
          type: "unique-value", 
          legendOptions: {
            title: "Accident Type"
          },
          field: "type",
          uniqueValueInfos: [{
            value: "pedestrian",
            symbol: pedSym,
            label: "pedestrian crash"
          }, {
            value: "bike", 
            symbol: bikeSym,
            label: "bike crash"
          }, {
            value: "bars", 
            symbol: barSym,
            label: "bar accidents"
          }, {
            value: "school",
            symbol: schoolSym,
            label: "school accidents"
          }]
        };

        function findMaxMin(inputField){
          if(inputField == "Bie" || inputField == "Pie" ) return [5, 27];
          
          else if (inputField == "BikeCrashC") return [0, 30];
          else if (inputField == "BikeExp") return [0, 35];
          else if (inputField == "Bike_Risk") return [0, 2.7];
          
          else if (inputField == "NMExp") return [0, 112];
          
          else if (inputField == "NMRisk") return [0, 5];
          
          else if (inputField == "PedCrashCt") return [0, 45];
        
          else if (inputField == "PedExp") return [0, 30];
          
          else if (inputField == "Ped_Risk") return [0, 3.8];
          
          else {
            console.log("Error in attribute max min value");
            return [0, 10];
          }
        }
        // Definition of polygon renderer with continuous color 
        function generatePolygonRenderer(inputField) {

          const minMaxValue = findMaxMin(fieldDictionary[inputField]); 
          const defaultSym = {
            type: "simple-fill", 
            outline: { 
              color: [128, 128, 128, 0.2],
              width: "0.5px"
            }
          };
          const colorVisVar = {
            type: "color",
            field: fieldDictionary[inputField],
            stops: [
              { value: minMaxValue[0], color: "#FFFCD4" },
              { value: minMaxValue[1], color: "#0D2644" }
            ],
            legendOptions: {
              title: "Polygon " + inputField + " value"
            }
          };
          var rendererPolygon = {
            type: "simple", // autocasts as new SimpleRenderer()
            symbol: defaultSym,
            label: "Polygon",
            visualVariables: colorVisVar
          };

          if (fieldDictionary[inputField] == "Pie"){
            rendererPolygon = rendererPolygonPie;
          }
          else if (fieldDictionary[inputField] == "Bie"){
        	rendererPolygon = rendererPolygonBie;
          }
          else if (fieldDictionary[inputField] == "Ped_Risk"){
        	rendererPolygon = rendererPolygon_PedRisk;
          }
          else if (fieldDictionary[inputField] == "Bike_Risk"){
        	rendererPolygon = rendererPolygon_BikeRisk;
          }
          else if (fieldDictionary[inputField] == "NMRisk"){
        	rendererPolygon = rendererPolygon_NM_Risk;
          }
          else if (fieldDictionary[inputField] == "PedExp"){
        	rendererPolygon = rendererPolygon_PedExposure;
          }
          else if (fieldDictionary[inputField] == "BikeExp"){
        	rendererPolygon = rendererPolygon_BikeExposure;
          }
          else if (fieldDictionary[inputField] == "NMExp") {
        	rendererPolygon = rendererPolygon_NM_Exposure;
          }
       	  return rendererPolygon;
    	}
  
        // Setting the polygon renderer to Bie as default before the polygon is added
        rendererPolygon = generatePolygonRenderer("Bike_Index_of_the_Environment");
        // Adding polygon featureLayer 
        const polygonLayer = new FeatureLayer({
          url: "https://services1.arcgis.com/4ezfu5dIwH83BUNL/arcgis/rest/services/pedbike_IE_NM_Michigan_shapefile/FeatureServer/0?token=rMw6H62pT88QenqnVIelUNZuGTfznwDXYRGNFth5Nxyxke02OOFDoSVZGtNS3LLXHpeMwSe3laxcUW6wnJBr8dbsRyCOwSJorr5r-UI-QdlaHseayLu4F4U5DDP7ZTtpf39x-PXeSK2AD6rINR6K69lK25DwQLtU_uTakeNWBpqQlqYzVqxLbS4S3YyrKDB-Oh-QNruzCqIzKUSjVYRbrpChDnlNFVhwqhBfPzjUpOIxNjTlvODddTUD6Ap3o5iH",
          outFields: ["*"],
          popupTemplate: popupTemplatePolygon,
          renderer: rendererPolygon,
          opacity:0.5,
          id: "polygonLayer",
          visible: true
        });
        map.add(polygonLayer);
        const lineBikeLayer = new FeatureLayer({
          url: "https://services1.arcgis.com/4ezfu5dIwH83BUNL/arcgis/rest/services/bike_roadwgts_Michigan_shapefile_aguise/FeatureServer/0?token=PwV--ijdr0r7rSJowrB_Mz84lRcQPbIOW_Ak4hq9tyioigHL4BOrsRGGUUaU4IJ2qJpltRBDvfg9kd7dTI3dcaapvamjKwaGQdB6J7gIPpGKUjJUbfHoFLU3LuaRRDhXkPsP0aA3fKjGyFSE0NikXl9hegzjjISpr3AB7nNNpZaKho2xdnJHmbNjivIlEYiZ-NnCeSNdbykkn2QmGz9YsNu-GUsbMs6-lrgMebrNmWvdE0GgRhA86PfDuy2nt41m",
          outFields: ["*"],
          popupTemplate: popupTemplateLineBike,
          id: "lineBikeLayer",
          visible: false
        });
        const linePedLayer = new FeatureLayer({
          url: "https://services1.arcgis.com/4ezfu5dIwH83BUNL/arcgis/rest/services/pedestrian_roadwgts_Michigan_shapefile/FeatureServer/0?token=aFKpBGnF5jBe8_RhnapvPxAXzuiDccdTnZJw7DKwjJa26IV2lbuN1zxW9o2OtpLtvpigU1xi7TiDjkOBJUt5lKuggQ1IU3OzM3fKq7fqTCyWYjeCYylNtQizmQb7__6sigbMZHcBO_Pve3W9pJePm8ZCAhWV-pTHPbh0vkHwPf6A8J8oroJ_DT1Q21Xmb80E7XlWdMl657FL3WnPpuvSS_P4f8xYsTqiray06aPgtklfbTmOoIbQzW1MuJookBev",
          outFields: ["*"],
          popupTemplate: popupTemplateLinePed,
          id: "linePedLayer",
          visible: false
        });

        var colorParamsPed = {
          layer: linePedLayer,
          basemap: map.basemap,
          field: "Shape__Length",
          legendOptions: {
          	title: "Pedestrian Exposure"
          },

        };
        var colorParamsBike = {
          layer: lineBikeLayer,
          basemap: map.basemap,
          field: "Shape__Length",
          legendOptions: {
          	title: "Bicycle Exposure"
          },
      	};
        const pointLayer = new FeatureLayer({
          url: "https://services1.arcgis.com/4ezfu5dIwH83BUNL/arcgis/rest/services/Points_of_Interest_aguise/FeatureServer/0?token=KZn8xOjNVlJcvNfbpkB-r0AXY_vUpPR0J-dGWx6jXx3GHWLlXAn--DjiehlRGWYJxo6cEdAYUDk-UKEznr3AOt9cvAmy5cr9DUURryn3ozlb4za5DNv6N93W_f8S21YAcpd9DHSa-heHedhv3EqDe43qpfvXAsGLeL7-DEAqPBxkt6SPX4evcgWLakiC53bUE_wLIZu4s-0GW_gFRJnjO1zRyk0K1D6zNyhkvSa5YEABprjlUSga0ISLWtHzT5jA",
          outFields: ["*"],
          popupTemplate: popupTemplatePoint,
          renderer: rendererPoint,
          visible: false,
          opacity: 0.5
        });
        map.add(pointLayer);
        // legend widget ============================================================
        const legend = new Legend({
          view: view
        });
        view.ui.add(legend, "bottom-left");
        
        // highlight when clicked ==========================================================================
        // Highlighting the point and create pop-up when clicked 
        let graphics;
        view.whenLayerView(polygonLayer).then(function(layerView) {
          let highlight;
          // listen for the pointer-move event on the View
          view.on("pointer-move", function(event) {
            // Perform a hitTest on the View
            view.hitTest(event).then(function(event) {
              // Make sure graphic has a popupTemplate
              let results = event.results.filter(function(
                result) {
                return result.graphic.layer.popupTemplate;
              });
              let result = results[0];
              highlight && highlight.remove();
              // Update the graphic of the Feature widget on pointer-move with the result
              if (result) {
                feature.graphic = result.graphic;
                highlight = layerView.highlight(result.graphic);
              } else {
                feature.graphic = graphic;
              }
            });
          });
        });
//----------------------------------------------------------------------------------------------------
        colorRendererCreator.createClassBreaksRenderer(colorParamsPed)
          .then(function(response) {
            // set the renderer to the layer and add it to the map
            linePedLayer.renderer = response.renderer;
            map.add(linePedLayer);
            return histogram({
              layer: linePedLayer,
              field: "Shape__Length"
            });
          })
          .catch(function(error) {
            console.log("there was an error: ", error);
          });
//----------------------------------------------------------------------------------------------------
        colorRendererCreator.createClassBreaksRenderer(colorParamsBike)
          .then(function(response) {
            // set the renderer to the layer and add it to the map
            lineBikeLayer.renderer = response.renderer;
            map.add(lineBikeLayer);
            return histogram({
              layer: lineBikeLayer,
              field: "Shape__Length"
            });
          })
          .catch(function(error) {
            console.log("there was an error: ", error);
          });
//----- select attribute ------------------------------------------------------------------------------
        
        var attributeTypeSelect = document.getElementById("att-type");
        var rangeSlider = document.getElementById("range");
        view.when(function () {
            return polygonLayer.when(function () {
              var query = polygonLayer.createQuery();
              return polygonLayer.queryFeatures(query);
            });
          })
          .then(getValues)
          .then(addToSelect);
        function getValues(response) {
          var fields = ["Bike_Index_of_the_Environment", "Bike_Exposure", "Bike_Risk", "Non_Motorized_Exposure", "Non_Motorized_Risk", "Pedestrian_Exposure", "Pedestrian_Risk", "Pedestrian_Index_of_the_Environment"];
          return fields;
        }
        function addToSelect(values) {
          values.forEach(function (value) {
            var option = document.createElement("option");
            option.text = value;
            attributeTypeSelect.add(option);
          });
          return setAttributeDefinitionExpression(attributeTypeSelect.value);
        }
        var infoTypeDictionary = {
          "Bike_Index_of_the_Environment": "pedestrian-index-of-the-environment-pie", 
          "Bike_Exposure":"exposure", 
          "Bike_Risk" : "risk-score", 
          "Non_Motorized_Exposure": "exposure",
          "Non_Motorized_Risk" : "risk-score",
          "Pedestrian_Exposure" : "exposure", 
          "Pedestrian_Risk": "risk-score", 
          "Pedestrian_Index_of_the_Environment": "pedestrian-index-of-the-environment-pie"
        }; 
        var rankDictionary = {
          "Bike_Index_of_the_Environment": "BIErank", 
          "Bike_Exposure":"BErank", 
          "Bike_Risk" : "BRrank", 
          "Non_Motorized_Exposure": "NMErank",
          "Non_Motorized_Risk" : "NMRrank",
          "Pedestrian_Exposure" : "PErank", 
          "Pedestrian_Risk": "PRrank", 
          "Pedestrian_Index_of_the_Environment": "PIErank"
        }; 
        // set the definition expression on the wells
        // layer to reflect the selection of the user
        function setAttributeDefinitionExpression(newValue) {
          polygonLayer.renderer = generatePolygonRenderer(newValue);
          if (!polygonLayer.visible) {
            polygonLayer.visible = true;
          }
        }
        var attType = "Bike_Index_of_the_Environment"; 
        
        // event listening for attribute change 
        attributeTypeSelect.addEventListener("change", function () {
          attType = event.target.value;
          setAttributeDefinitionExpression(attType);
          var infoUrl = "https://github.com/caocscar/pedbikeriskexposure/blob/master/draft.md#" + infoTypeDictionary[attType];
          document.getElementById("infoUrl").href = infoUrl;
        });
        function filterByValue(){
          var rangeSelectPercentage = parseInt(rangeSlider.value);
          if (rangeSelectPercentage == 100) 
            polygonLayer.definitionExpression = ""; 
          else{
            polygonLayer.definitionExpression = rankDictionary[attType] +" <= " + rangeSelectPercentage+ 
                                                " AND " + rankDictionary[attType] + " > 0";
            // console.log(polygonLayer.definitionExpression);
          }
        }
        // event listening to range change for filter 
        rangeSlider.addEventListener("input", function () {
          document.getElementById("range-value").innerText = rangeSlider.value;
        });
        rangeSlider.addEventListener("change", function () {
          filterByValue();
        });
        /*****************************************************************
         * The visible property on the layer can be used to toggle the
         * layer's visibility in the view. When the visibility is turned off
         * the layer is still part of the map, which means you can access
         * its properties and perform analysis even though it isn't visible.
         *******************************************************************/
        var polygonLayerToggle = document.getElementById("polygonLayer");
        polygonLayerToggle.addEventListener("change", function () {
          polygonLayer.visible = polygonLayerToggle.checked;
        });
        var pedLayerToggle = document.getElementById("pedLayer");
        pedLayerToggle.addEventListener("change", function () {
          linePedLayer.visible = pedLayerToggle.checked;
          lineBikeLayer.visible = false; 
        });
        var bikeLayerToggle = document.getElementById("bikeLayer");
        bikeLayerToggle.addEventListener("change", function () {
          lineBikeLayer.visible = bikeLayerToggle.checked;
          linePedLayer.visible = false; 
        });
        var offLayerToggle = document.getElementById("offLayer");
        offLayerToggle.addEventListener("change", function () {
          lineBikeLayer.visible = false;
          linePedLayer.visible = false; 
        });
        var pointLayerToggle = document.getElementById("pointLayer");
        pointLayerToggle.addEventListener("change", function () {
          pointLayer.visible = pointLayerToggle.checked;
        });
        // Changing the visibility if the zoom level is too low
        watchUtils.whenTrue(view, "stationary", function() {
          if (view.zoom) {
            if (view.zoom < 11){
              console.log("WARNING: stopped rendering due to low zoom level at", view.zoom, ".");
              polygonLayer.visible = false; 
              lineBikeLayer.visible = false; 
              linePedLayer.visible = false; 
              pointLayer.visible = false; 
            }
            else {
              polygonLayer.visible = polygonLayerToggle.checked; 
              lineBikeLayer.visible = bikeLayerToggle.checked; 
              linePedLayer.visible = pedLayerToggle.checked; 
              pointLayer.visible = pointLayerToggle.checked; 
            }
          }
        });
      });
  </script>

  <style>
    html,
    body,
    #viewDiv {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    #backgroundDiv {
      top: 85px;
      left: 1025px;
      position: absolute;
      z-index: 99;
      background-color: black;
      color: White;
      border-radius: 8px;
      font-size:90%;
      padding: 10px;
      width: 220px;
      opacity: 1;      
    }
    #infoDiv {
      top: 160px;
      left: 1025px;
      position: absolute;
      z-index: 99;
      background-color: black;
      color: #fff;
      border-radius: 8px;
      font-size:80%;
      padding: 10px;
      width: 220px;
      opacity: 1;
    }
    #layerToggle {
      top: 240px;
      left: 1025px;
      position: absolute;
      z-index: 99;
      background-color: black;
      color: #fff;
      border-radius: 8px;
      font-size:80%;
      padding: 10px;
      width: 220px;
      opacity: 1;
    }
    .panel-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div class="panel-container">

    <div id = "backgroundDiv">
      Pedestrian and Bicyclist Safety Risk Assessment Tool <br/>
      <a href="https://github.com/caocscar/pedbikeriskexposure/blob/master/draft.md" target="_blank" style="color:yellow">Reseach Info</a>
    </div>

    <div id="infoDiv">
      Select attribute: &nbsp;&nbsp;  
        <a id="infoUrl" href="https://github.com/caocscar/pedbikeriskexposure/blob/master/draft.md#pedestrian-index-of-the-environment-pie" target="_blank" style="color:yellow"> Attribute Info </a> <br/> 
      <select id="att-type" style = "width: 215px"></select> 
      <br> Range:
      <input id="range" type="range" min="10" max="100" step="10" value="100"> 
      <span id="range-value"> 100 </span>
    </div>
    
    <span id="layerToggle">
      Layers <br/>
      <input type="checkbox" id="polygonLayer" checked> Polygon Layer <br/>
      <input type="checkbox" id="pointLayer"> Points of Interest Layer <br/>

      <input type="radio" name="lineLayer" id="pedLayer"> Ped Road Layer <br/>
      <input type="radio" name="lineLayer" id="bikeLayer"> Bike Road Layer <br/>
      <input type="radio" name="lineLayer" id="offLayer"> Turn Off Road Layer 
    </span>

    <div id="viewDiv"></div>
  </div>
</body>
</html>
